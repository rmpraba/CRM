
<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="schedule-service">
  <template>
     <!-- It would fetch the grade -->
     <iron-ajax
        method="post"
        id="fetchgradeajax"
        url="{{fetchgradeurl}}"
        params="{{fetchgradeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchgradeResponse"
        debounce-duration="300"
        >
         <!-- It would fetch the academic year -->
     <iron-ajax
        method="post"
        id="fetchacademicyearajax"
        url="{{fetchacademicyearurl}}"
        params="{{fetchacademicyearparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchacademicyearResponse"
        debounce-duration="300"
        >
         <!-- It would fetch the admission year -->
     <iron-ajax
        method="post"
        id="fetchadmissionyearajax"
        url="{{fetchadmissionyearurl}}"
        params="{{fetchadmissionyearparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchadmissionyearResponse"
        debounce-duration="300"
        >
          <!-- It would fetch fee type -->
     <iron-ajax
        method="post"
        id="fetchfeetypeajax"
        url="{{fetchfeetypeurl}}"
        params="{{fetchfeetypeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchfeetypeResponse"
        debounce-duration="300"
        >
        <!-- Generate Fee code -->
     <iron-ajax
        method="post"
        id="generatefeecodeajax"
        url="{{generatefeecodeurl}}"
        params="{{generatefeecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generatefeecodeResponse"
        debounce-duration="300"
        >
         <!-- Generate Fee code -->
     <iron-ajax
        method="post"
        id="createfeecodeajax"
        url="{{createfeecodeurl}}"
        params="{{createfeecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="createfeecodeResponse"
        debounce-duration="300"
        >
     <!-- Generate Fee code splitup-->
     <iron-ajax
        method="post"
        id="feecodesplitupajax"
        url="{{feecodesplitupurl}}"
        params="{{feecodesplitupparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="feecodesplitupResponse"
        debounce-duration="300"
        >
          <!-- It would fetch discount type-->
     <iron-ajax
        method="post"
        id="fetchdiscounttypeajax"
        url="{{fetchdiscounttypeurl}}"
        params="{{fetchdiscounttypeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchdiscounttypeResponse"
        debounce-duration="300"
        >
           <!-- Generate discount code -->
     <iron-ajax
        method="post"
        id="generatediscountcodeajax"
        url="{{generatediscountcodeurl}}"
        params="{{generatediscountcodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generatediscountcodeResponse"
        debounce-duration="300"
        >
         <!-- Create discount code -->
     <iron-ajax
        method="post"
        id="creatediscountcodeajax"
        url="{{creatediscountcodeurl}}"
        params="{{creatediscountcodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="creatediscountcodeResponse"
        debounce-duration="300"
        >

          <!-- It would fetch fee component type -->
     <iron-ajax
        method="post"
        id="fetchfeecomponenttypeajax"
        url="{{fetchfeecomponenttypeurl}}"
        params="{{fetchfeecomponenttypeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchfeecomponenttypeResponse"
        debounce-duration="300"
        >        

          <!-- It would fetch fee component info -->
     <iron-ajax
        method="post"
        id="fetchfeecomponentinfoajax"
        url="{{fetchfeecomponentinfourl}}"
        params="{{fetchfeecomponentinfoparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchfeecomponentinfoResponse"
        debounce-duration="300"
        >

         <!-- It generate installment code-->
     <iron-ajax
        method="post"
        id="generateinstallmentcodeajax"
        url="{{generateinstallmentcodeurl}}"
        params="{{generateinstallmentcodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generateinstallmentcodeResponse"
        debounce-duration="300"
        >

         <!-- It would fetch fee component info -->
     <iron-ajax
        method="post"
        id="createinstallmentajax"
        url="{{createinstallmenturl}}"
        params="{{createinstallmentparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="createinstallmentResponse"
        debounce-duration="300"
        >

          <!-- It would fetch fee component info -->
     <iron-ajax
        method="post"
        id="createinstallmentsplitupajax"
        url="{{createinstallmentsplitupurl}}"
        params="{{createinstallmentsplitupparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="createinstallmentsplitupResponse"
        debounce-duration="300"
        >

       <!-- Fetch installment pattern-->
     <iron-ajax
        method="post"
        id="fetchinstallmentpatternajax"
        url="{{fetchinstallmentpatternurl}}"
        params="{{fetchinstallmentpatternparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchinstallmentpatternResponse"
        debounce-duration="300"
        >  
      <!-- Fetch installment pattern-->
     <iron-ajax
        method="post"
        id="fetchinstallmentfeecodeajax"
        url="{{fetchinstallmentfeecodeurl}}"
        params="{{fetchinstallmentfeecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchinstallmentfeecodeResponse"
        debounce-duration="300"
        >
      <!-- Fetch installment pattern-->
     <iron-ajax
        method="post"
        id="fetchinstallmentdiscountcodeajax"
        url="{{fetchinstallmentdiscountcodeurl}}"
        params="{{fetchinstallmentdiscountcodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchinstallmentdiscountcodeResponse"
        debounce-duration="300"
        >
         <!-- Fetch installment pattern-->
     <iron-ajax
        method="post"
        id="fetchtotalinstallmentfeecodeajax"
        url="{{fetchtotalinstallmentfeecodeurl}}"
        params="{{fetchtotalinstallmentfeecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchtotalinstallmentfeecodeResponse"
        debounce-duration="300"
        >
      <!-- Fetch installment pattern-->
     <iron-ajax
        method="post"
        id="fetchtotalinstallmentdiscountcodeajax"
        url="{{fetchtotalinstallmentdiscountcodeurl}}"
        params="{{fetchtotalinstallmentdiscountcodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchtotalinstallmentdiscountcodeResponse"
        debounce-duration="300"
        >
        <!-- Generate installment schedule code-->
     <iron-ajax
        method="post"
        id="generateinstallmentschedulecodeajax"
        url="{{generateinstallmentschedulecodeurl}}"
        params="{{generateinstallmentschedulecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generateinstallmentschedulecodeResponse"
        debounce-duration="300"
        >
        <!-- Create installment schedule-->
     <iron-ajax
        method="post"
        id="createinstallmentschedulecodeajax"
        url="{{createinstallmentschedulecodeurl}}"
        params="{{createinstallmentschedulecodeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="createinstallmentschedulecodeResponse"
        debounce-duration="300"
        >
          <!-- Generate installment schedule code-->
     <iron-ajax
        method="post"
        id="generateinstallmentscheduleajax"
        url="{{generateinstallmentscheduleurl}}"
        params="{{generateinstallmentscheduleparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="generateinstallmentscheduleResponse"
        debounce-duration="300"
        >
        <!-- Create installment schedule-->
     <iron-ajax
        method="post"
        id="createinstallmentscheduleajax"
        url="{{createinstallmentscheduleurl}}"
        params="{{createinstallmentscheduleparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="createinstallmentscheduleResponse"
        debounce-duration="300"
        >
  </template>
  <script>
  (function() {
    'use strict';
    var count1=0,count2=0;
    var insstructure=[];
    var insfeecode=[];
    var insdiscountcode=[];
    var insschedulearr=[];
    var instotalfeearr=[];
    var instotalfees="";
    var instotaldiscountarr=[];
    Polymer({
      is: 'schedule-service',
      fetchgradeService:function(){       
        this.fetchgradeurl=sessionStorage.getItem("addrinfo")+"/fetchgrade-service"
        this.$.fetchgradeajax.generateRequest();
      },
      fetchgradeResponse:function(e){
        document.querySelector('feetype-schedule-card').gradearr=e.detail.response.returnval;
        document.querySelector('discount-master-card').gradearr=e.detail.response.returnval;
        document.querySelector('fee-structure-schedulecard').gradearr=e.detail.response.returnval;
        document.querySelector('installment-master-card').gradearr=e.detail.response.returnval;
        document.querySelector('admission-form').fromgradearr=e.detail.response.returnval;
        document.querySelector('admission-form').togradearr=e.detail.response.returnval;
      },
      fetchacademicyearService:function(){        
        this.fetchacademicyearurl=sessionStorage.getItem("addrinfo")+"/fetchacademicyear-service"
        this.$.fetchacademicyearajax.generateRequest();
      },
      fetchacademicyearResponse:function(e){
        document.querySelector('feetype-schedule-card').academicarr=e.detail.response.returnval;
        document.querySelector('discount-master-card').academicarr=e.detail.response.returnval;
        document.querySelector('fee-structure-schedulecard').academicarr=e.detail.response.returnval;
        document.querySelector('installment-master-card').academicarr=e.detail.response.returnval;
        document.querySelector('admission-form').academicarr=e.detail.response.returnval;
      },
      fetchadmissionyearService:function(){        
        this.fetchadmissionyearurl=sessionStorage.getItem("addrinfo")+"/fetchadmissionyear-service"
        this.$.fetchadmissionyearajax.generateRequest();
      },
      fetchadmissionyearResponse:function(e){        
        document.querySelector('feetype-schedule-card').admissionarr=e.detail.response.returnval;
        document.querySelector('discount-master-card').admissionarr=e.detail.response.returnval;
        document.querySelector('fee-structure-schedulecard').admissionarr=e.detail.response.returnval;
        document.querySelector('installment-master-card').admissionarr=e.detail.response.returnval;

      },
      fetchfeetypeService:function(){        
        this.fetchfeetypeurl=sessionStorage.getItem("addrinfo")+"/fetchfeetype-service"
        this.$.fetchfeetypeajax.generateRequest();
      },
      fetchfeetypeResponse:function(e){
        document.querySelector('feetype-schedule-card').feetypearr=e.detail.response.returnval;
        document.querySelector('discount-master-card').feetypearr=e.detail.response.returnval;
        document.querySelector('fee-structure-schedulecard').feetypearr=e.detail.response.returnval;
      },
      fetchdiscounttypeService:function(){
        this.fetchdiscounttypeurl=sessionStorage.getItem("addrinfo")+"/fetchdiscounttype-service"
        this.$.fetchdiscounttypeajax.generateRequest();
      },
      fetchdiscounttypeResponse:function(e){   
        // alert(JSON.stringify(e.detail.response.returnval));     
        document.querySelector('discount-master-card').discountarr=e.detail.response.returnval;
        document.querySelector('fee-structure-schedulecard').discountarr=e.detail.response.returnval;
      },
      fetchfeecomponenttypeService:function(){
        this.fetchfeecomponenttypeurl=sessionStorage.getItem("addrinfo")+"/fetchfeecomponenttype-service"
        this.$.fetchfeecomponenttypeajax.generateRequest();
      },
      fetchfeecomponenttypeResponse:function(e){
        // alert(JSON.stringify(e.detail.response.returnval));
        document.querySelector('fee-structure-schedulecard').componentarr=e.detail.response.returnval;
      },
      setFeeTypeInfo:function(schoolname,grade,admissionyear,academicyear,feetype,totalfees,feetypeinstallment){        
        this.schoolname=schoolname;
        this.grade=grade;
        this.admissionyear=admissionyear;
        this.academicyear=academicyear;
        this.feetype=feetype;
        this.totalfees=totalfees;
        this.feetypeinstallment=feetypeinstallment;
        this.feename=localStorage.getItem("shortname")+"-Ad"+(admissionyear).substring(3)+"-Ac"+(academicyear).substring(3)+"-"+grade;
        this.generatefeecodeService();
      },
      generatefeecodeService:function(){        
        this.generatefeecodeurl=sessionStorage.getItem("addrinfo")+"/generatefeecode-service";
        var obj={"schoolid":"","prefixid":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;
        obj.prefixid=1;
        this.generatefeecodeparam=obj;
        // alert(JSON.stringify(obj));
        this.$.generatefeecodeajax.generateRequest();
      },
      generatefeecodeResponse:function(e){
        // alert(e.detail.response.returnval);
        if(e.detail.response.returnval=="seqfail"){
          alert('Feecode creation fail!!');
        }
        else if(e.detail.response.returnval=="prefixfail"){
          alert('Feecode creation fail!!');
        }
        else{          
          this.feecode=e.detail.response.returnval;
          this.createfeecodeService();
        }
      },
      createfeecodeService:function(){
        this.createfeecodeurl=sessionStorage.getItem("addrinfo")+"/createfeecode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":"","feetype":"","totalfees":"","installment":"","installmentamount":"","installmentdate":"","feecode":"","feename":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;        
        obj.feecode=this.feecode;
        obj.feename=this.feename;
        obj.feetype=this.feetype;
        obj.totalfees=this.totalfees;
        obj.feetypeinstallment=this.feetypeinstallment;
        obj.createdby=localStorage.getItem("employeeid");
        this.createfeecodeparam=obj;
        this.$.createfeecodeajax.generateRequest();
      },
      createfeecodeResponse:function(e){
        alert(e.detail.response.returnval);
        // alert(JSON.stringify(e.detail.response.returnval));
      },
      setDiscountInfo:function(schoolname,grade,admissionyear,academicyear,discounttypecode,discounttype,feetype,fromdate,todate,amount,admissiontype){
        this.schoolname=schoolname;
        this.grade=grade;
        this.admissionyear=admissionyear;
        this.academicyear=academicyear;
        this.feetype=feetype;
        this.discounttypecode=discounttypecode;
        this.discounttype=discounttype;
        this.admissiontype=admissiontype;
        this.fromdate=fromdate;
        this.todate=todate;
        this.amount=amount;
        this.generatediscountcodeService();
      },
      generatediscountcodeService:function(){        
        this.generatediscountcodeurl=sessionStorage.getItem("addrinfo")+"/generatediscountcode-service";
        var obj={"schoolid":"","prefixid":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;
        obj.feecode=this.feecode;        
        obj.feetype=this.feetype;
        obj.discounttypecode=this.discounttypecode;
        obj.discounttype=this.discounttype;
        obj.admissiontype=this.admissiontype;
        obj.amount=this.amount;
        obj.prefixid=2;
        obj.fromdate=this.fromdate;
        obj.todate=this.todate;
        // this.discountname=localStorage.getItem("shortname")+"-Ad"+(admissionyear).substring(3)+"-Ac"+(academicyear).substring(3)+"-"+grade;
        this.generatediscountcodeparam=obj;
        // alert(JSON.stringify(obj));
        this.$.generatediscountcodeajax.generateRequest();
      },
      generatediscountcodeResponse:function(e){
        alert(e.detail.response.returnval);
        if(e.detail.response.returnval=="seqfail"){
          alert('Discountcode creation fail!!');
        }
        else if(e.detail.response.returnval=="prefixfail"){
          alert('Discountcode creation fail!!');
        }
        else if(e.detail.response.returnval=="exist"){
          alert('Discount of this feetype for this period already exist!!');
        }
        else{          
          this.discountcode=e.detail.response.returnval;
          this.creatediscountcodeService();
        }
      },
      creatediscountcodeService:function(){
        this.creatediscountcodeurl=sessionStorage.getItem("addrinfo")+"/creatediscountcode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":"","feetype":"","totalfees":"","installment":"","installmentamount":"","installmentdate":"","feecode":"","feename":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;        
        obj.discountcode=this.discountcode;
        obj.feetype=this.feetype;
        obj.discounttypecode=this.discounttypecode;
        obj.discounttype=this.discounttype;
        obj.admissiontype=this.admissiontype;
        obj.amount=this.amount;
        obj.fromdate=this.fromdate;
        obj.todate=this.todate;
        obj.createdby=localStorage.getItem("employeeid");
        this.creatediscountcodeparam=obj;
        this.$.creatediscountcodeajax.generateRequest();
      },
      creatediscountcodeResponse:function(e){
        alert(e.detail.response.returnval);
        // alert(JSON.stringify(e.detail.response.returnval));
      },
      generateinstallmentscheduleService:function(consolidatedinsfeearr){
        // alert(localStorage.getItem("curr_sess_noofinstallment"));
        this.generateinstallmentscheduleurl=sessionStorage.getItem("addrinfo")+"/generateinstallmentschedule-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
              this.consolidatedinsfeearr=consolidatedinsfeearr;
              obj.schoolid=localStorage.getItem("schoolid");
              obj.academicyear=localStorage.getItem("curr_sess_academicyear");
              obj.admissionyear=localStorage.getItem("curr_sess_admissionyear");
              obj.grade=localStorage.getItem("curr_sess_grade"); 
              obj.discounttypecode=localStorage.getItem("curr_sess_discounttypecode"); 
              obj.discounttype=localStorage.getItem("curr_sess_discounttype"); 
              obj.noofinstallment=localStorage.getItem("curr_sess_noofinstallment");
              obj.admissiontype=localStorage.getItem("curr_sess_admissiontype");                 
              obj.prefixid=4;
              obj.createdby=localStorage.getItem("employeeid");
        this.generateinstallmentscheduleparam=obj;
        this.$.generateinstallmentscheduleajax.generateRequest();
      },
      generateinstallmentscheduleResponse:function(e){
        // alert(e.detail.response.returnval);
        if(e.detail.response.returnval!='fail'){
          this.installmentschcode=e.detail.response.returnval;
          this.createinstallmentscheduleService();
        }
      },
      createinstallmentscheduleService:function(){
        this.createinstallmentscheduleurl=sessionStorage.getItem("addrinfo")+"/createinstallmentschedule-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        
        count1=(this.consolidatedinsfeearr).length;      
        
        // alert(this.consolidatedinsfeearr[0].noofinstallment);

        for(var i=0;i<(this.consolidatedinsfeearr).length;i++){
          obj.schoolid=localStorage.getItem("schoolid");
          obj.academicyear=this.consolidatedinsfeearr[i].academicyear;
          obj.admissionyear=this.consolidatedinsfeearr[i].admissionyear;
          obj.grade=this.consolidatedinsfeearr[i].grade;
          obj.noofinstallment=this.consolidatedinsfeearr[i].noofinstallment;
          obj.discounttypecode=this.consolidatedinsfeearr[i].discounttypecode;
          obj.discounttype=this.consolidatedinsfeearr[i].discounttype;
          obj.admissiontype=this.consolidatedinsfeearr[i].admissiontype;
          obj.discountcode=this.consolidatedinsfeearr[i].discountcode;
          obj.feecode=this.consolidatedinsfeearr[i].feecode;
          obj.feetype=this.consolidatedinsfeearr[i].feetype;
          obj.actualamount=this.consolidatedinsfeearr[i].actualamount;
          obj.discountamount=this.consolidatedinsfeearr[i].discountamount;
          obj.payableamount=this.consolidatedinsfeearr[i].payableamount;
          obj.insschedulecode=this.installmentschcode;
          obj.createdby=localStorage.getItem("employeeid");
          // alert(JSON.stringify(obj));
          this.createinstallmentscheduleparam=obj;
          this.$.createinstallmentscheduleajax.generateRequest();
        }        
      },
      createinstallmentscheduleResponse:function(e){
        // alert(e.detail.response.returnval); 
       if(e.detail.response.returnval=='created'){
        count2++;
       }
       if(count1==count2){
        alert("Created!");
        count1=0;count2=0;        
       }
       // count1=0;count2=0;
      },
      setInstallmentFeecomponent:function(schoolname,grade,admissionyear,academicyear,noofinstallment,discountcode,discounttype,installmentarr,installmentsubarr,admissiontype){
        this.schoolname=schoolname;
        this.grade=grade;
        this.admissionyear=admissionyear;
        this.academicyear=academicyear;
        this.noofinstallment=noofinstallment;
        this.discountcode=discountcode;
        this.discounttype=discounttype;
        this.admissiontype=admissiontype;
        this.installmentarr=installmentarr;
        this.installmentsubarr=installmentsubarr;
        this.generateinstallmentcodeService();
      },
      generateinstallmentcodeService:function(){
        this.generateinstallmentcodeurl=sessionStorage.getItem("addrinfo")+"/generateinstallmentcode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;
        obj.discountcode=this.discountcode;
        obj.discounttype=this.discounttype;
        obj.admisssiontype=this.admissiontype;   
        obj.prefixid=3;
        obj.createdby=localStorage.getItem("employeeid");
        this.generateinstallmentcodeparam=obj;
        this.$.generateinstallmentcodeajax.generateRequest();
      },
      generateinstallmentcodeResponse:function(e){
        alert(e.detail.response.returnval);
        if(e.detail.response.returnval!='fail'){
          this.installmentcode=e.detail.response.returnval;
          this.createinstallmentService();
        }
      },
      createinstallmentService:function(){
        this.createinstallmenturl=sessionStorage.getItem("addrinfo")+"/createinstallment-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear; 
        obj.discountcode=this.discountcode;
        obj.discounttype=this.discounttype; 
        obj.admisssiontype=this.admissiontype;        
        obj.installmentcode=this.installmentcode;
        obj.noofinstallment=this.noofinstallment;
        obj.createdby=localStorage.getItem("employeeid");
        count1=(this.installmentarr).length;      
        // alert((this.installmentarr).length); 
        // alert(JSON.stringify(this.installmentarr)); 
        for(var i=0;i<(this.installmentarr).length;i++){
          obj.installment=this.installmentarr[i].installment;
          obj.installmenttype=this.installmentarr[i].installmenttype;
          obj.actualamount=this.installmentarr[i].actualamount;
          obj.discount=this.installmentarr[i].discount;
          obj.payableamount=this.installmentarr[i].payableamount;
          obj.installmentdate=this.installmentarr[i].installmentdate;
          obj.createdby=localStorage.getItem("employeeid");
          // alert(JSON.stringify(obj));
          this.createinstallmentparam=obj;
          this.$.createinstallmentajax.generateRequest();
        }        
      },
      createinstallmentResponse:function(e){
        alert(e.detail.response.returnval); 
       if(e.detail.response.returnval=='created'){
        count2++;
       }
       if(count1==count2){
        alert("Created!");
        count1=0;count2=0;
        this.createinstallmentsplitupService();
       }
       // count1=0;count2=0;
      },
      createinstallmentsplitupService:function(){
        this.createinstallmentsplitupurl=sessionStorage.getItem("addrinfo")+"/createinstallmentsplitup-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;        
        obj.installmentcode=this.installmentcode;
        obj.noofinstallment=this.noofinstallment;
        obj.discountcode=this.discountcode;
        obj.discounttype=this.discounttype;
        obj.createdby=localStorage.getItem("employeeid");
        count1=(this.installmentsubarr).length;
        for(var i=0;i<(this.installmentsubarr).length;i++){
          obj.installment=this.installmentsubarr[i].installment;
          obj.installmenttype=this.installmentsubarr[i].installmenttype;
          obj.feetype=this.installmentsubarr[i].feetype;
          obj.actualamount=this.installmentsubarr[i].actualamount;
          obj.discount=this.installmentsubarr[i].discount;
          obj.payableamount=this.installmentsubarr[i].payableamount;
          obj.installmentdate=this.installmentsubarr[i].installmentdate;
          obj.createdby=localStorage.getItem("employeeid");
          this.createinstallmentsplitupparam=obj;
          this.$.createinstallmentsplitupajax.generateRequest();
        }        
      },
      createinstallmentsplitupResponse:function(e){
        alert(e.detail.response.returnval); 
       if(e.detail.response.returnval=='created'){
        count2++;
       }
       if(count1==count2){
        alert("Created!");
       }
      },
      fetchinstallmentStructure:function(grade,academicyear,admissionyear){
        this.grade=grade;
        this.academicyear=academicyear;
        this.admissionyear=admissionyear;
        this.fetchinstallmentpattern();
      },
      fetchinstallmentpattern:function(){
         this.fetchinstallmentpatternurl=sessionStorage.getItem("addrinfo")+"/fetchinstallmentpattern-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;        
        this.fetchinstallmentpatternparam=obj;
        this.$.fetchinstallmentpatternajax.generateRequest();      
      },
      fetchinstallmentpatternResponse:function(e){
        insstructure=e.detail.response.returnval;
        this.fetchinstallmentfeecode();
      },
      fetchinstallmentfeecode:function(feetype){
        this.feetype=feetype;
        this.schoolid=localStorage.getItem("schoolid");
        this.grade=localStorage.getItem("curr_sess_grade");
        this.admissionyear=localStorage.getItem("curr_sess_admissionyear");
        this.academicyear=localStorage.getItem("curr_sess_academicyear");
        this.fetchinstallmentfeecodeurl=sessionStorage.getItem("addrinfo")+"/fetchinstallmentfeecode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":"","feetype":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear; 
        obj.feetype=feetype;       
        this.fetchinstallmentfeecodeparam=obj;
        this.$.fetchinstallmentfeecodeajax.generateRequest();
      },
      fetchinstallmentfeecodeResponse:function(e){
        insfeecode=e.detail.response.returnval;
        this.fetchinstallmentdiscountcode();
      },
      fetchinstallmentdiscountcode:function(){
        this.fetchinstallmentdiscountcodeurl=sessionStorage.getItem("addrinfo")+"/fetchinstallmentdiscountcode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear; 
        obj.feetype=this.feetype;       
        this.fetchinstallmentdiscountcodeparam=obj;
        this.$.fetchinstallmentdiscountcodeajax.generateRequest();
      },
      fetchinstallmentdiscountcodeResponse:function(e){
        insdiscountcode=e.detail.response.returnval;
        document.querySelector('fee-type-card').actualamount=insfeecode[0].total_fee;
        document.querySelector('fee-type-card').discount=insdiscountcode[0].amount;
        document.querySelector('fee-type-card').payableamount=parseInt(insfeecode[0].total_fee)-parseInt(insdiscountcode[0].amount);       
        document.querySelector('installment-fee-type-card').actualamount=insfeecode[0].total_fee;
        document.querySelector('installment-fee-type-card').discount=insdiscountcode[0].amount;
        document.querySelector('installment-fee-type-card').payableamount=parseInt(insfeecode[0].total_fee)-parseInt(insdiscountcode[0].amount);
      },
      fetchtotalinstallmentfeecode:function(discountcode,discounttype,admissiontype){
        // this.feetype=feetype;
        this.schoolid=localStorage.getItem("schoolid");
        this.grade=localStorage.getItem("curr_sess_grade");
        this.admissionyear=localStorage.getItem("curr_sess_admissionyear");
        this.academicyear=localStorage.getItem("curr_sess_academicyear");
        this.discountcode=discountcode;
        this.discounttype=discounttype;
        this.admissiontype=admissiontype;
        this.fetchtotalinstallmentfeecodeurl=sessionStorage.getItem("addrinfo")+"/fetchtotalinstallmentfeecode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":"","feetype":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear; 
        // obj.feetype=feetype;       
        this.fetchtotalinstallmentfeecodeparam=obj;
        this.$.fetchtotalinstallmentfeecodeajax.generateRequest();
      },
      fetchtotalinstallmentfeecodeResponse:function(e){
        instotalfeearr=e.detail.response.returnval;
        instotalfees=e.detail.response.totalfees;
        // for(var i=0;i<instotalfeearr.length;i++){
        //   if(instotalfeearr[i].feetype=="Registration fee")
        //     this.no=0;
        //   else
        //     this.no=-1;
        // }
        // alert('hi!!!'+document.querySelector('fee-structure-schedulecard'));
        // document.querySelector('fee-structure-schedulecard').FnMakeVisbleInstallmentCard(this.no);
        this.fetchtotalinstallmentdiscountcode();
      },
      fetchtotalinstallmentdiscountcode:function(){
        this.fetchtotalinstallmentdiscountcodeurl=sessionStorage.getItem("addrinfo")+"/fetchtotalinstallmentdiscountcode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.schoolname=this.schoolname;
        obj.grade=this.grade;
        obj.admissionyear=this.admissionyear;
        obj.academicyear=this.academicyear;
        obj.discountcode=this.discountcode;
        obj.discounttype=this.discounttype;
        obj.admissiontype=this.admissiontype; 
        // obj.feetype=this.feetype; 
        var dt=new Date();
        var d=dt.getDate();
        var m=(dt.getMonth()+1);
        var y=dt.getFullYear();
        if(d<10)
          d="0"+d;
        if(m<10)
          m="0"+m;
        obj.currdate=m+"/"+d+"/"+y;      
        this.fetchtotalinstallmentdiscountcodeparam=obj;
        this.$.fetchtotalinstallmentdiscountcodeajax.generateRequest();
      },
      fetchtotalinstallmentdiscountcodeResponse:function(e){
        instotaldiscountarr=e.detail.response.returnval;    
               
        document.querySelector('installment-fee-type-card').FnSetTotalFeeInstallment(instotalfeearr,instotaldiscountarr);
        instotalfeearr=[];
        instotaldiscountarr=[];
      },
      setInstallmentScheduleInfo:function(schdulearr){
        this.schdulearr=schdulearr;
        this.generateinstallmentschedulecodeService();
      }, 
      generateinstallmentschedulecodeService:function(){
        this.generateinstallmentschedulecodeurl=sessionStorage.getItem("addrinfo")+"/generateinstallmentschedulecode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
          obj.schoolid=localStorage.getItem("schoolid");
          obj.grade=this.schdulearr[0].grade;
          obj.admissionyear=this.schdulearr[0].admissionyear;
          obj.academicyear=this.schdulearr[0].academicyear; 
          obj.prefixid=4;
          this.generateinstallmentschedulecodeparam=obj;
          this.$.generateinstallmentschedulecodeajax.generateRequest();       
      },
      generateinstallmentschedulecodeResponse:function(e){
        if(e.detail.response.returnval!="seqfail"){
          this.insschedulecode=e.detail.response.returnval;
          alert(e.detail.response.returnval);
          this.createinstallmentschedulecodeService();
        }
      },     
      createinstallmentschedulecodeService:function(){
        this.createinstallmentschedulecodeurl=sessionStorage.getItem("addrinfo")+"/createinstallmentschedulecode-service";
        var obj={"schoolid":"","schoolname":"","grade":"","admissionyear":"","academicyear":""};
        count1=(this.schdulearr).length;
        for(var i=0;i<(this.schdulearr).length;i++){
          obj.schoolid=localStorage.getItem("schoolid");
          obj.grade=this.schdulearr[i].grade;
          obj.admissionyear=this.schdulearr[i].admissionyear;
          obj.academicyear=this.schdulearr[i].academicyear; 
          obj.installment=this.schdulearr[i].installment; 
          obj.installmentcode=this.schdulearr[i].installmentcode; 
          obj.feecode=this.schdulearr[i].feecode; 
          obj.discountcode=this.schdulearr[i].discountcode;       
          obj.installmenttype=this.schdulearr[i].installmenttype;
          obj.feetype=this.schdulearr[i].feetype;
          obj.totalamount=this.schdulearr[i].totalamount;
          obj.discount=this.schdulearr[i].discount;
          obj.payableamount=this.schdulearr[i].payableamount;
          obj.installmentdate=this.schdulearr[i].installmentdate;
          obj.insschedulecode=this.insschedulecode;
          obj.createdby=localStorage.getItem("employeeid");
          this.createinstallmentschedulecodeparam=obj;
          this.$.createinstallmentschedulecodeajax.generateRequest();
        }        
      },
      createinstallmentschedulecodeResponse:function(e){
        if(e.detail.response.returnval=="created")
          count2++;
        if(count1==count2)
          alert('Created!');
        else
          alert('Not created!');
      }
    });
  })();
  </script>
</dom-module>

