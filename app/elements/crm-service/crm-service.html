<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="crm-service">
  <template>
  <!-- This ajax is used to submit the simple enquiry details of the student for the first time -->
     <iron-ajax
        method="post"
        id="submitenquiryajax"
        url="{{submitenquiryurl}}"
        params="{{submitenquiryparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="submitenquiryResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- It update the already entered student details with more information after the counselling using student name or enquiry number -->
  <iron-ajax
        method="post"
        id="updateenquiryajax"
        url="{{updateenquiryurl}}"
        params="{{updateenquiryparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="updateenquiryResponse"
        debounce-duration="300"
        >
  </iron-ajax>
<!-- this ajax is to get the total sequence number that has been created depending on the enquiry -->
 <iron-ajax
        method="post"
        id="getenquirynoajax"
        url="{{getenquirynourl}}"
        params="{{getenquirynoparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getenquirynoResponse"
        debounce-duration="300"
        >
  </iron-ajax>
<!-- this ajax is to fetch the available classes with repect to the school -->
   <iron-ajax
        method="post"
        id="getclassesajax"
        url="{{getclassesurl}}"
        params="{{getclassesparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getclassesResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this ajax fetched the list of locations available with respect to school -->
  <iron-ajax
        method="post"
        id="getlocationajax"
        url="{{getlocationurl}}"
        params="{{getlocationparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getlocationResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this ajax is to fetch the name of student those who filled simple enquiry form and ready to fill the detailed enquiry form after counselling -->
  <iron-ajax
        method="post"
        id="getstudentnameajax"
        url="{{getstudentnameurl}}"
        params="{{getstudentnameparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getstudentnameResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this below ajax is to update the sequence number only when the enquiry form is submitted -->
  <iron-ajax
        method="post"
        id="updateseqajax"
        url="{{updatesequrl}}"
        params="{{updateseqparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="updateseqResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this ajax is used to get the details of the particular enquiry using enquiry no -->
  <iron-ajax
        method="post"
        id="getenqirydetailsajax"
        url="{{getenqirydetailsurl}}"
        params="{{getenqirydetailsparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getenqirydetailsResponse"
        debounce-duration="300"
        >
  </iron-ajax>

<!-- this ajax is to verify with the database whether the specific number is existing in database or not -->
  <iron-ajax
        method="post"
        id="verifymobilenoajax"
        url="{{verifymobilenourl}}"
        params="{{verifymobilenoparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="verifymobilenoResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this below ajax gives the total number of enquiry appeared categorized based on the grade -->
  <iron-ajax
        method="post"
        id="getenquirycountajax"
        url="{{getenquirycounturl}}"
        params="{{getenquirycountparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getenquirycountResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this ajax gets the student list who all are enquired for admission and not yet been admitted -->
  <iron-ajax
        method="post"
        id="getlistdetailsajax"
        url="{{getlistdetailsurl}}"
        params="{{getlistdetailsparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getlistdetailsResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this below ajax is used to get the sequence value of prospectus from the table -->
  <iron-ajax
        method="post"
        id="getprospectnoajax"
        url="{{getprospectnourl}}"
        params="{{getprospectnoparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="getprospectnoResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  <!-- this ajax is used to update the prospectus number in the sequence table -->
  <iron-ajax
        method="post"
        id="updateprospectnoajax"
        url="{{updateprospectnourl}}"
        params="{{updateprospectnoparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="updateprospectnoResponse"
        debounce-duration="300"
        >
  </iron-ajax>

  <!-- this below ajax gets the day counts for follow up from the config file -->
   <iron-ajax
        auto
        id="followupajax"
        url="../../configfile/followups.json"
        handle-as="json"
        content-type="application/json"
        on-response="followupResponse"
        debounce-duration="300"
        >
  </iron-ajax>

  <!-- this ajax is used to update the follow up info in followup table -->
  <iron-ajax
        method="post"
        id="updatefollowajax"
        url="{{updatefollowurl}}"
        params="{{updatefollowparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="updatefollowResponse"
        debounce-duration="300"
        >
  </iron-ajax>

  <!-- this below ajax is used to insert data in the follow up detail table 
  -->
  <iron-ajax
        method="post"
        id="updatefollowdetailajax"
        url="{{updatefollowdetailurl}}"
        params="{{updatefollowdetailparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="updatefollowdetailResponse"
        debounce-duration="300"
        >
  </iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';
   var seqno;
   var proseq;
   var firstfollowup;
   var secondfollowup;
   var thirdfollowup;
   var fourthfollowup;
   var fifthfollowup;
   var firstfollowupdate;
   var secondfollowupdate;
   var thirdfollowupdate;
   var fourthfollowupdate;
   var fifthfollowupdate;

    Polymer({
      is: 'crm-service',
      followupResponse:function(e){
        firstfollowup=e.detail.response.firstfollowup;
        secondfollowup=e.detail.response.secondfollowup;
         thirdfollowup=e.detail.response.thirdfollowup;
         fourthfollowup=e.detail.response.fourthfollowup;
         fifthfollowup=e.detail.response.fifthfollowup;

         firstfollowupdate=new Date();
         secondfollowupdate=new Date();
         thirdfollowupdate=new Date();
         fourthfollowupdate=new Date();
         fifthfollowupdate=new Date();

    firstfollowupdate.setDate(firstfollowupdate.getDate()+firstfollowup);
    secondfollowupdate.setDate(secondfollowupdate.getDate()+secondfollowup);
    thirdfollowupdate.setDate(thirdfollowupdate.getDate()+thirdfollowup);
    fourthfollowupdate.setDate(fourthfollowupdate.getDate()+fourthfollowup);
    fifthfollowupdate.setDate(fifthfollowupdate.getDate()+fifthfollowup);
      },
     submitenqiry:function(enqno,academicyear,grade,Fnfirstname,Fnmiddlename,Fnlastname,gender,dob,fathername,mothername,mob,email,textvalue,todate){
      //alert(enqno+academicyr+classes+studentname+gender+dob+mob+source+locality+category);
      var generateid=Math.floor(100000 + Math.random() * 900000);
        this.submitenquiryurl="http://localhost:8086/submitenquiry";
        var obj={"id":"","schol":"","acadeyr":"","contact":"","grade":"","gender":"","firstname":"","middlename":"","lastname":"","dobs":"","father":"","mother":"","email":"","location":"","createdby":"","createdate":"","givenname":"","status":""}
        obj.id=enqno;
        obj.schol=localStorage.getItem("schoolid");
        obj.acadeyr=academicyear;
        obj.grade=grade;
        obj.contact=mob;
        obj.gender=gender;
        obj.firstname=Fnfirstname;
        obj.middlename=Fnmiddlename;
        obj.lastname=Fnlastname;
        obj.dobs=dob;
        obj.father=fathername;
        obj.mother=mothername;
        obj.email=email;
        obj.location=textvalue;
        obj.createdby=localStorage.getItem("employeeid");
        obj.createdate=todate;
        obj.givenname=Fnfirstname+' '+Fnmiddlename+' '+Fnlastname;
        obj.status="Enquired";
        this.submitenquiryparam=obj;
       //alert(JSON.stringify(obj));
        this.$.submitenquiryajax.generateRequest();

      this.updatefollowurl="http://localhost:8086/updatefollow";
        var obj={"schol":"","id":"","enquiryno":"","schedule":"","createdby":"","createdon":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.id=generateid;
        obj.enquiryno=enqno;
        obj.schedule=1;
        obj.createdby=localStorage.getItem("employeeid");
        obj.createdon=todate;
        this.updatefollowparam=obj;
       //alert(JSON.stringify(obj));
        this.$.updatefollowajax.generateRequest();

      this.updatefollowdetailurl="http://localhost:8086/updatefollowdetail";
        var obj={"schol":"","id":"","enquiryid":"","folowup1":"","folowup2":"","folowup3":"","folowup4":"","folowup5":"","nextfolowup":"","schedule":"","flag":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.id=generateid;
        obj.enquiryid=enqno;
        obj.folowup1=firstfollowupdate.getDate()+"/"+(firstfollowupdate.getMonth()+1)+"/"+firstfollowupdate.getFullYear();
        obj.folowup2=secondfollowupdate.getDate()+"/"+(secondfollowupdate.getMonth()+1)+"/"+secondfollowupdate.getFullYear();
        obj.folowup3=thirdfollowupdate.getDate()+"/"+(thirdfollowupdate.getMonth()+1)+"/"+thirdfollowupdate.getFullYear();
        obj.folowup4=fourthfollowupdate.getDate()+"/"+(fourthfollowupdate.getMonth()+1)+"/"+fourthfollowupdate.getFullYear();
        obj.folowup5=fifthfollowupdate.getDate()+"/"+(fifthfollowupdate.getMonth()+1)+"/"+fifthfollowupdate.getFullYear();
        obj.nextfolowup=todate;
        obj.flag=1;
        obj.schedule=1;
        this.updatefollowdetailparam=obj;
       //alert(JSON.stringify(obj));
        this.$.updatefollowdetailajax.generateRequest();
     },
     submitenquiryResponse:function(e){
      var result=e.detail.response.returnval;
      if(result=="success"){
        alert("Submited Successfully");

        this.updatesequrl="http://localhost:8086/updateseq";
        var obj={"id":"","schol":""}
        obj.id=seqno;
        obj.schol=localStorage.getItem("schoolid");
        this.updateseqparam=obj;
       //alert(JSON.stringify(obj));
        this.$.updateseqajax.generateRequest();


        document.querySelector('newenquiry-card').Fnclear();
      }
      else{
        alert('Form submit interrupted');
      }

      
     },
     updateenquiryform:function(enqno,firstname,middlename,lastname,gender,grade,dob,oldclass,oldschool,mothertongue,fathername,mothername,fatheredu,motheredu,fathermob,mothermob,fathermail,mothermail,fathercompany,mothercompany,fatherjob,motherjob,flat,address1,address2,address3,city,pincode,state,enquiysource,siblingname,siblingdetail,transportreq,canteenreq,secondlanguage,thirdlanguage,propspectus,dadpost,mompost,dadsalary,momsalary,prospect){
      //alert(enqno+firstname+middlename+lastname+gender+grade+dob+oldclass+oldschool+mothertongue+fathername+mothername+fatheredu+motheredu+fathermob+mothermob+fathermail+mothermail+fathercompany+mothercompany+fatherjob+motherjob+flat+address1+address2+address3+city+pincode+state+enquiysource+siblingname+siblingdetail+transportreq+canteenreq+secondlanguage+thirdlanguage+propspectus+dadpost+mompost+dadsalary+momsalary);
      this.updateenquiryurl="http://localhost:8086/updateenquiry";
        var obj={"schol":"","enq":"","firstname":"","middlename":"","lastname":"","gender":"","grade":"","dob":"","oldclass":"","oldschool":"","mothertongue":"","fathername":"","mothername":"","fatheredu":"","motheredu":"","fathermob":"","mothermob":"","fathermail":"","mothermail":"","fathercompany":"","mothercompany":"","fatherjob":"","motherjobfn":"","flatno":"","address1":"","address2":"","address3":"","city":"","pincode":"","statename":"","enquiysource":"","siblingname":"","siblingdetails":"","transportreq":"","canteenreq":"","secondlanguage":"","thirdlanguage":"","modified":"","prospectstatus":"","daddesignation":"","momdesignation":"","dadincome":"","momincome":"","prospectusno":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.enq=enqno;
        obj.firstname=firstname;
        obj.middlename=middlename;
        obj.lastname=lastname;
        obj.gender=gender;
        obj.grade=grade;
        obj.dob=dob;
        obj.oldclass=oldclass;
        obj.oldschool=oldschool;
        obj.mothertongue=mothertongue;
        obj.fathername=fathername;
        obj.mothername=mothername;
        obj.fatheredu=fatheredu;
        obj.motheredu=motheredu;
        obj.fathermob=fathermob;
        obj.mothermob=mothermob;
        obj.fathermail=fathermail;
        obj.mothermail=mothermail;
        obj.fathercompany=fathercompany;
        obj.mothercompany=mothercompany;
        obj.fatherjob=fatherjob;
        obj.motherjobfn=motherjob;
        obj.flatno=flat;
        obj.address1=address1;
        obj.address2=address2;
        obj.address3=address3;
        obj.city=city;
        obj.pincode=pincode;
        obj.statename=state;
        obj.enquiysource=enquiysource;
        obj.siblingname=siblingname;
        obj.siblingdetails=siblingdetail;
        obj.transportreq=transportreq;
        obj.canteenreq=canteenreq;
        obj.secondlanguage=secondlanguage;
        obj.thirdlanguage=thirdlanguage;
        obj.modified=localStorage.getItem("employeeid");
        obj.prospectstatus=propspectus;
        obj.daddesignation=dadpost;
        obj.momdesignation=mompost;
        obj.dadincome=dadsalary;
        obj.momincome=momsalary;
        obj.prospectusno=prospect;
        this.updateenquiryparam=obj;
       alert(JSON.stringify(obj));
        this.$.updateenquiryajax.generateRequest();


        if((prospect!="")||(prospect!=null)){
          this.updateprospectnourl="http://localhost:8086/updateprospectno";
        var obj={"schol":"","id":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.id=proseq;
        this.updateprospectnoparam=obj;
       //alert(JSON.stringify(obj));
        this.$.updateprospectnoajax.generateRequest();
        }
     },
     updateenquiryResponse:function(e){
      var result=e.detail.response.returnval;
      if(result="success"){
        alert("Submited Successfully");
      }
     },
     getenquiryno:function(){
      this.getenquirynourl="http://localhost:8086/getenquiryno";
        var obj={"schol":""}
        obj.schol=localStorage.getItem("schoolid");
        this.getenquirynoparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getenquirynoajax.generateRequest();
     },
     getenquirynoResponse:function(e){
      seqno=e.detail.response.returnval[0].enquiry_no;
      //alert(seqno);
      seqno=seqno+1;
      var enquiryif="ENQ1718"+seqno;
      document.querySelector('newenquiry-card').enqno=enquiryif;
      var today = new Date(); var yyyy = today.getFullYear(); 
      var academicyr=yyyy+'-'+(yyyy+1);
      document.querySelector('newenquiry-card').academicyr=academicyr;

     },
      getclasses:function(){
      this.getclassesurl="http://localhost:8086/getclasses";
        var obj={"schol":""}
        obj.schol=localStorage.getItem("schoolid");
        this.getclassesparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getclassesajax.generateRequest();
     },
     getclassesResponse:function(e){
        var result=e.detail.response.returnval;
      document.querySelector('newenquiry-card').itemarr=result;        
     },
     getlocation:function(){
      this.getlocationurl="http://localhost:8086/getlocation";
        var obj={"schol":""}
        obj.schol=localStorage.getItem("schoolid");
        this.getlocationparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getlocationajax.generateRequest();
     },
     getlocationResponse:function(e){
        var result=e.detail.response.returnval;
        //alert(JSON.stringify(result));
      document.querySelector('newenquiry-card').autocompletename(result);        
     },
/*     getstudentname:function(){
        this.getstudentnameurl="http://localhost:8086/getstudentname";
        var obj={"schol":""}
        obj.schol=localStorage.getItem("schoolid");
        this.getstudentnameparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getstudentnameajax.generateRequest();
     },
     getstudentnameResponse:function(e){
      var result=e.detail.response.returnval;
      document.querySelector('detail-enquiry-card').autocompletename(result);
     },*/
     getenqirydetails:function(enq){
      alert(enq);
       this.getenqirydetailsurl="http://localhost:8086/getenqirydetails";
        var obj={"schol":"","enqno":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.enqno=enq;
        this.getenqirydetailsparam=obj;
       //alert('hello   '+JSON.stringify(obj));
        this.$.getenqirydetailsajax.generateRequest(); 
     },
     getenqirydetailsResponse:function(e){
      var result=e.detail.response.returnval;
      //alert(JSON.stringify(result));
      //alert(document.querySelector('detail-enquiry-form'));
      //alert(result[0].first_name);
      if(result.length>=0){
      document.querySelector('detailed-enquiry-form').firstname=result[0].first_name;
      document.querySelector('detailed-enquiry-form').middlename=result[0].middle_name;
      document.querySelector('detailed-enquiry-form').lastname=result[0].last_name;
      document.querySelector('detailed-enquiry-form').dob=result[0].dob;
      document.querySelector('detailed-enquiry-form').fathermob=result[0].father_mob;
      document.querySelector('detailed-enquiry-form').fathername=result[0].father_name;
      document.querySelector('detailed-enquiry-form').mothername=result[0].mother_name;
      document.querySelector('detailed-enquiry-form').fathermail=result[0].father_email;
      document.querySelector('detailed-enquiry-form').grade=result[0].class;
      document.querySelector('detailed-enquiry-form').Fnresult(result[0].dob,result[0].gender);
    }
    else{
      alert('Invalid Enquiry number');
    }
     },
     checkmobileno:function(mobile){
          this.verifymobilenourl="http://localhost:8086/verifymobileno";
        var obj={"mobileno":"","schol":""}
        obj.mobileno=mobile;
        obj.schol=localStorage.getItem("schoolid");
        this.verifymobilenoparam=obj;
       //alert(JSON.stringify(obj));
        this.$.verifymobilenoajax.generateRequest();
     },
     verifymobilenoResponse:function(e){
        var result=e.detail.response.returnval;
        if(result.length>=0){

            document.querySelector('newenquiry-card').showdialog(result[0].enquiry_no,result[0].first_name,result[0].middle_name,result[0].last_name);
        }
     },
     getenquirycount:function(){
        this.getenquirycounturl="http://localhost:8086/getenquirycount";
        var obj={"schol":"","status":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.status="Enquired";
        this.getenquirycountparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getenquirycountajax.generateRequest();
     },
     getenquirycountResponse:function(e){
      var result=e.detail.response.returnval;
      document.querySelector('enquiry-card').gradewisearr=result;
     },
     getlistdetails:function(classes){
           this.getlistdetailsurl="http://localhost:8086/getlistdetails";
        var obj={"schol":"","grade":"","status":""}
        obj.schol=localStorage.getItem("schoolid");
        obj.grade=classes;
        obj.status="Enquired";
        this.getlistdetailsparam=obj;
       //alert(JSON.stringify(obj));
        this.$.getlistdetailsajax.generateRequest();
     },
     getlistdetailsResponse:function(e){
          var result=e.detail.response.returnval;
          //alert(JSON.stringify(result));
          document.querySelector('enquiry-details-card').listdetails=result;
     },
     getprospectno:function(){
        this.getprospectnourl="http://localhost:8086/getprospectno";
        var obj={"schol":""}
        obj.schol=localStorage.getItem("schoolid");
        this.getprospectnoparam=obj;
       alert(JSON.stringify(obj));
        this.$.getprospectnoajax.generateRequest();
     },
     getprospectnoResponse:function(e){
      var result=e.detail.response.returnval[0].prospectus_no;
      alert(result);
      var dt=new Date();
      var year=dt.getFullYear();
      var mnth=dt.getMonth()+1;
      proseq=result+1;
      if(mnth>=9){
        year=year+1;
      }
      var prospectus="PROS"+year+(year+1)+proseq;
      document.querySelector('detailed-enquiry-form').prospectusno=prospectus;
     }

    });
  })();
  </script>
</dom-module>
